<h1>VibeCodingLab (Python 智能診斷平台)</h1>
<h2>專案總覽 (Project Overview)</h2>
<p>本專案是一個基於 Python Flask 的 Web 應用程式，旨在提供學生一個互動式的 Python 程式練習環境。系統結合了 OpenAI 的大型語言模型 (LLM)，能針對學生的程式碼提供即時的執行結果、錯誤分析、評分與優化建議。</p>
<ul>
<li><strong>解決的問題</strong>：提供初學者即時且具體的程式碼回饋，解決自學時缺乏指導的痛點。</li>
<li><strong>使用對象</strong>：Python 程式語言初學者、程式設計課程學生。</li>
<li><strong>專案性質</strong>：Web Application (前後端分離架構)。</li>
</ul>
<h2>系統架構說明 (Architecture Overview)</h2>
<p>本系統採用前後端分離設計。後端使用 Flask 框架處理 API 請求、程式碼安全性檢查與執行；前端使用純 HTML/CSS/JS 構建。外部依賴包括 OpenAI API (用於代碼分析) 與 Google Sheets (用於題目管理與成績記錄)。</p>
<h3>系統架構圖</h3>
<pre><code class="language-mermaid">flowchart TD
    User[&quot;使用者 (Browser)&quot;] &lt;--&gt;|HTTP/JSON| Frontend[&quot;前端介面 (HTML/JS)&quot;]
    Frontend &lt;--&gt;|REST API| Backend[&quot;後端伺服器 (Flask)&quot;]

    subgraph Backend_System [後端系統]
        Backend --&gt;|1. 驗證與執行| Sandbox[&quot;安全執行沙箱 (Safe Exec)&quot;]
        Backend --&gt;|2. 題目管理| QuestionLoader[&quot;題目讀取模組 (Fetch Questions)&quot;]
        Backend --&gt;|3. 成績處理| ScoreManager[&quot;成績管理模組&quot;]
    end

    subgraph External_Services [外部服務]
        Backend &lt;--&gt;|分析請求| OpenAI[&quot;OpenAI API&quot;]
        QuestionLoader &lt;--&gt;|讀取 CSV| GSheets[&quot;Google Sheets (題目資料庫)&quot;]
        ScoreManager --&gt;|寫入成績| GWebApp[&quot;Google Apps Script (成績記錄)&quot;]
    end

    ScoreManager --&gt;|備份| LocalFile[&quot;本地 JSON 檔案&quot;]
</code></pre>
<h2>系統流程說明 (System Flow)</h2>
<p>主要流程包含：題目載入、程式碼執行、AI 分析與成績提交。</p>
<h3>核心運作流程圖</h3>
<pre><code class="language-mermaid">sequenceDiagram
    participant U as 使用者
    participant F as 前端介面
    participant S as Flask Server
    participant AI as OpenAI API
    participant DB as Google Sheets

    Note over U, DB: 1. 題目載入流程
    U-&gt;&gt;F: 開啟頁面
    F-&gt;&gt;S: GET /api/questions
    alt 快取有效
        S--&gt;&gt;F: 回傳 tool/questions.json 快取
    else 快取過期
        S-&gt;&gt;DB: 讀取題目 CSV
        DB--&gt;&gt;S: 回傳資料
        S-&gt;&gt;S: 解析並更新快取
        S--&gt;&gt;F: 回傳新題目列表
    end

    Note over U, DB: 2. 程式執行與分析流程
    U-&gt;&gt;F: 撰寫程式碼並執行
    F-&gt;&gt;S: POST /api/execute/interactive
    S-&gt;&gt;S: 安全性檢查 (AST Parse)
    alt 檢查通過
        S-&gt;&gt;S: 在沙箱中執行程式
        S--&gt;&gt;F: 回傳執行結果 (Output)

        U-&gt;&gt;F: 請求 AI 分析
        F-&gt;&gt;S: POST /api/ai/analyze
        S-&gt;&gt;AI: 發送程式碼與結果
        AI--&gt;&gt;S: 回傳評分與建議 (JSON)
        S--&gt;&gt;F: 顯示分析結果
    else 檢查失敗
        S--&gt;&gt;F: 回傳安全性錯誤
    end

    Note over U, DB: 3. 成績提交流程
    U-&gt;&gt;F: 提交成績
    F-&gt;&gt;S: POST /api/scores/submit
    par 雙重寫入
        S-&gt;&gt;DB: 呼叫 Google Apps Script 寫入
        S-&gt;&gt;S: 寫入 tool/scores_backup.json (本地備份)
    end
    S--&gt;&gt;F: 回傳提交狀態
</code></pre>
<h2>資料夾結構說明 (Folder Structure)</h2>
<pre><code>VibeCodingLab/14/
├── frontend/                  # 前端靜態資源
│   ├── index.html             # 主頁面
│   ├── styles.css             # 樣式表
│   ├── app.js                 # 主要邏輯 (Vue/Vanilla JS)
│   ├── api.js                 # API 封裝
│   ├── config.js              # 前端設定
│   └── lib/                   # 第三方函式庫
├── tool/                      # 工具與資料模組
│   ├── fetch_questions.py     # Google Sheets 題目抓取邏輯
│   ├── prompts.json           # AI 提示詞模板設定
│   ├── questions.json         # 題目資料快取
│   └── scores_backup.json     # 成績本地備份
├── server.py                  # 後端核心程式 (Flask App)
├── config.json                # 後端設定檔 (API Keys 等)
├── requirements.txt           # Python 套件依賴清單
└── service-account.json       # Google 服務帳號憑證 (選用)
</code></pre>
<h2>核心模組與重要檔案 (Key Modules &amp; Files)</h2>
<h3>1. <code>server.py</code> (後端核心)</h3>
<ul>
<li><strong>職責</strong>：啟動 Web Server，處理所有 API 路由。</li>
<li><strong>關鍵功能</strong>：</li>
<li><code>validate_code_safety(code)</code>: 使用 AST (抽象語法樹) 檢查程式碼，禁止危險函數 (如 <code>open</code>, <code>eval</code>, <code>os</code> 等)。</li>
<li><code>execute_with_timeout</code>: 在獨立執行緒中執行學生程式碼，防止無窮迴圈 (預設 5 秒超時)。</li>
<li><code>start_interactive_execution</code>: 處理互動式程式執行 (支援 <code>input()</code> 函數)。</li>
<li><code>/api/ai/*</code>: 處理與 OpenAI 的串接，包含分析、檢查與建議。</li>
</ul>
<h3>2. <code>tool/fetch_questions.py</code> (題目載入器)</h3>
<ul>
<li><strong>職責</strong>：從 Google Sheets CSV 匯出連結讀取題目資料。</li>
<li><strong>邏輯</strong>：</li>
<li>解析 CSV 格式，處理用雙引號包夾的欄位。</li>
<li>自動判斷題目難度與學習目標。</li>
<li>將資料結構化並儲存為 JSON。</li>
</ul>
<h3>3. <code>frontend/app.js</code> (前端邏輯)</h3>
<ul>
<li><strong>職責</strong>：管理使用者介面互動。</li>
<li><strong>功能</strong>：</li>
<li>程式碼編輯器 (CodeMirror/Monaco) 初始化。</li>
<li>調用後端 API 執行程式並顯示結果。</li>
<li>渲染 Markdown 格式的 AI 回饋。</li>
</ul>
<h2>安裝與環境需求 (Installation &amp; Requirements)</h2>
<h3>系統需求</h3>
<ul>
<li>Python 3.8 或以上版本</li>
<li>網路連線 (需存取 Google Sheets 與 OpenAI API)</li>
</ul>
<h3>相依套件</h3>
<p>請參考 <code>requirements.txt</code>：</p>
<pre><code class="language-text">flask
flask-cors
openai
requests
gspread
google-auth
</code></pre>
<h3>安裝步驟</h3>
<ol>
<li>建立虛擬環境 (建議)：
   <code>bash
   python -m venv venv
   source venv/bin/activate  # Windows: venv\Scripts\activate</code></li>
<li>安裝套件：
   <code>bash
   pip install -r requirements.txt</code></li>
</ol>
<h2>使用方式 (How to Use)</h2>
<h3>1. 啟動伺服器</h3>
<p>在專案根目錄執行：</p>
<pre><code class="language-bash">python server.py
</code></pre>
<p>成功啟動後，控制台會顯示：</p>
<pre><code>[Vibe] Python 診斷平台 - OpenAI 版 (Model: gpt-4o-mini)
 * Running on http://0.0.0.0:5000/
</code></pre>
<h3>2. 操作介面</h3>
<ul>
<li>打開瀏覽器訪問 <code>http://localhost:5000</code> (或 <code>index.html</code> 直接打開，視前端配置而定)。</li>
<li>選擇左側題目列表。</li>
<li>在中央編輯器輸入 Python 程式碼。</li>
<li>點擊「執行程式」查看輸出。</li>
<li>點擊「AI 分析」獲取評分與建議。</li>
</ul>
<h2>設定說明 (Configuration)</h2>
<h3>後端設定 (<code>config.json</code>)</h3>
<p>此檔案需自行建立，格式如下：</p>
<pre><code class="language-json">{
  &quot;openai_api_key&quot;: &quot;sk-proj-...&quot;,
  &quot;model_name&quot;: &quot;gpt-4o-mini&quot;
}
</code></pre>
<h3>提示詞設定 (<code>tool/prompts.json</code>)</h3>
<p>定義 AI 分析時使用的 System Prompt 與 User Prompt 模板，可熱更新。</p>
<ul>
<li><code>analyze_prompt</code>: 用於 <code>/api/ai/analyze</code></li>
<li><code>suggest_prompt</code>: 用於 <code>/api/ai/suggest</code></li>
</ul>
<h2>開發者指南 (Developer Guide)</h2>
<h3>修改建議</h3>
<ol>
<li>
<p><strong>安全性調整</strong>：</p>
</li>
<li>
<p>若需開放更多 Python 模組，請修改 <code>server.py</code> 中的 <code>ALLOWED_MODULES</code> 集合。</p>
</li>
<li><strong>警告</strong>：請勿隨意移除 <code>validate_code_safety</code> 中的檢查，以免造成伺服器安全風險。</li>
<li>
<p><strong>題目來源</strong>：</p>
</li>
<li>
<p>目前指向特定的 Google Sheet URL (在 <code>tool/fetch_questions.py</code> 中定義)。</p>
</li>
<li>若需更換題庫，請修改 <code>SHEET_URL</code> 常數。</li>
</ol>
<h3>擴充功能</h3>
<ul>
<li><strong>新增 API</strong>：在 <code>server.py</code> 中使用 <code>@app.route</code> 裝飾器新增路由。</li>
<li><strong>前端調整</strong>：主要修改 <code>frontend/app.js</code> 與 <code>frontend/index.html</code>。</li>
</ul>
<h2>已知限制與待辦事項 (Limitations &amp; TODO)</h2>
<ul>
<li>
<p><strong>安全性限制</strong>：</p>
</li>
<li>
<p>目前僅支援標準函式庫的子集 (math, random, datetime 等)。</p>
</li>
<li>無法執行需要檔案系統讀寫的操作。</li>
<li><code>input()</code> 互動功能在某些瀏覽器環境下可能會有延遲。</li>
<li>
<p><strong>TODO</strong>：</p>
</li>
<li>
<p>[ ] 實作使用者登入系統。</p>
</li>
<li>[ ] 將成績儲存改為真正的資料庫 (如 SQLite/PostgreSQL)，而非依賴 Google Sheets。</li>
<li>[ ] 增強沙箱隔離機制 (考慮使用 Docker 或更底層的隔離)。</li>
</ul>
<h2>補充說明 (Notes)</h2>
<ul>
<li><strong>成績備份機制</strong>：系統會優先嘗試寫入 Google Apps Script Web App。若失敗，會自動降級並寫入 <code>tool/scores_backup.json</code>，確保資料不丟失。</li>
<li><strong>快取機制</strong>：題目資料預設快取 30 分鐘 (<code>server.py</code> 中的 <code>CACHE_EXPIRE_MINUTES</code>)，可透過 <code>/api/questions/refresh</code> 強制更新。</li>
</ul>